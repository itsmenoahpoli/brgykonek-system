# Railway deployment configuration for BrgyKonek Web
# This Caddyfile serves the Angular application with proper routing and security headers

# Use Railway's PORT environment variable
:{$PORT:80} {
	# Set the root directory where the built Angular app is located
	root * /srv
	
	# Enable compression for better performance
	encode gzip zstd
	
	# Serve static files
	file_server
	
	# Angular routing - fallback to index.html for SPA routing
	try_files {path} /index.html
	
	# Security headers
	header {
		# HSTS - Force HTTPS (only on HTTPS)
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		
		# Prevent clickjacking
		X-Frame-Options "DENY"
		
		# Control referrer information
		Referrer-Policy "strict-origin-when-cross-origin"
		
		# Content Security Policy for Angular apps
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://brgykonekapi.up.railway.app;"
		
		# XSS Protection
		X-XSS-Protection "1; mode=block"
		
		# Remove server information
		-Server
		
		# Cache control for static assets
		Cache-Control "public, max-age=31536000" {
			/assets/*
			/*.js
			/*.css
			/*.ico
			/*.png
			/*.jpg
			/*.jpeg
			/*.gif
			/*.svg
			/*.woff
			/*.woff2
			/*.ttf
			/*.eot
		}
		
		# No cache for index.html to ensure updates are loaded
		Cache-Control "no-cache, no-store, must-revalidate" {
			/index.html
		}
	}
	
	# API proxy (if needed for development/testing)
	# Uncomment and modify if you need to proxy API calls
	# handle /api/* {
	# 	reverse_proxy https://brgykonekapi.up.railway.app {
	# 		header_up Host {upstream_hostport}
	# 		header_up X-Real-IP {remote_host}
	# 		header_up X-Forwarded-For {remote_host}
	# 		header_up X-Forwarded-Proto {scheme}
	# 	}
	# }
	
	# Handle Angular service worker (if using PWA)
	handle /ngsw.json {
		header Cache-Control "no-cache, no-store, must-revalidate"
		file_server
	}
	
	# Handle service worker files
	handle /ngsw-worker.js {
		header Cache-Control "no-cache, no-store, must-revalidate"
		file_server
	}
	
	# Handle favicon and other root-level files
	handle /favicon.ico {
		file_server
	}
	
	# Logging
	log {
		output file /var/log/caddy/access.log
		format json
	}
	
	# Error handling
	handle_errors {
		@404 {
			expression {http.error.status_code} == 404
		}
		rewrite @404 /index.html
		file_server
	}
}

